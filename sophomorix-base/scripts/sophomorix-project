#!/usr/bin/perl -w
# Dieses Script (sophomorix-project) wurde von Rüdiger Beck erstellt
# Es ist freie Software
# Bei Fehlern wenden Sie sich bitte an mich.
# jeffbeck@web.de  oder  jeffbeck@gmx.de


# ===========================================================================
# Bibliotheken
# ===========================================================================
use strict;
use Getopt::Long;
Getopt::Long::Configure ("bundling");
use Sophomorix::SophomorixConfig;
use Sophomorix::SophomorixBase;
use Sophomorix::SophomorixAPI;
#use Sophomorix::SophomorixFiles;
#use Schedule::at;

use DBI;
use Net::LDAP;


# ===========================================================================
# Loading the db-Module, list of functions
# ===========================================================================
# list of functions to load if db is 'files'
#use if ${DevelConf::db_backend} eq 'files' , 
#    'Sophomorix::SophomorixFiles' => qw(show_modulename
#                                        check_connections
#                                        show_project_list
#                                       );
# list of functions to load if db is 'pgldap'
#use if ${DevelConf::db_backend} eq 'pgldap' , 
#    'Sophomorix::SophomorixPgLdap' => qw(show_modulename
#                                        db_connect
#                                        db_disconnect
#                                        check_connections
#                                        show_project_list
#                                        show_project
#                                        create_project
#                                        remove_project
#                                        remove_class_db_entry
#                                       );

use Sophomorix::SophomorixPgLdap qw(show_modulename
                                    db_connect
                                    db_disconnect
                                    check_connections
                                    show_project_list
                                    show_project
                                    create_project
                                    remove_project
                                    remove_class_db_entry
                                   );


# ===========================================================================
# Loading the sys-db-Module, list of functions
# ===========================================================================
# list of functions to load if sys_db is 'files'
#use if ${DevelConf::sys_db} eq 'files' , 
#    'Sophomorix::SophomorixSYSFiles' => qw(show_sys_modulename
#                                          );

# list of functions to load if sys_db is 'pgldap'
#use if ${DevelConf::sys_db} eq 'pgldap' , 
#    'Sophomorix::SophomorixSYSPgLdap' => qw(show_sys_modulename
#                                          );



# ===========================================================================
# Optionen verarbeiten
# ==========================================================================

my $pg_timestamp=&pg_timestamp();

# Variablen für Optionen
$Conf::log_level=1;
my $help=0;
my $info=0;
my $create=0;
my $kill=0;
$Conf::log_level=1;

my $project="";

my $k;
my $v;

my $p_long_name;
my $p_admins;
my $p_groups;
my $p_members;
my $p_projects;
my $p_add_quota;
my $p_add_mail_quota;
my $p_max_members;
my $mailalias;
my $p_mailalias;
my $maillist;
my $p_maillist;
my $p_status;
my $join; # 0,1
my $p_join="TRUE"; # FALSE,TRUE

#my @options=();

# Parsen der Optionen
my $testopt=GetOptions(
           "help|h" => \$help,
           "info|i" => \$info,
           "create" => \$create,
           "kill" => \$kill,
           "verbose|v+" => \$Conf::log_level,
           "join!" => \$join,
           "Name|project|p=s" => \$project,
           "LongName=s" => \$p_long_name,
           "MemberGroups=s" => \$p_groups,
           "Admins=s" => \$p_admins,
           "Members=s" => \$p_members,
           "MemberProjects=s" => \$p_projects,
           "AddQuota=s" => \$p_add_quota,
           "AddMailQuota=s" => \$p_add_mail_quota,
           "MaxMembers=s" => \$p_max_members,
           "mailalias!" => \$mailalias,
           "maillist!" => \$maillist,
          );

# Prüfen, ob Optionen erkannt wurden
&check_options($testopt);


if ($project eq ""
    and $info==0
    ){
    $help=1;
}



# --help
if ($help==1) {
   # Scriptname ermitteln
   my @list = split(/\//,$0);
   my $scriptname = pop @list;
   # Befehlbeschreibung
   print('
sophomorix-project adds projects to the sophomorix database and adds users
   or groups as members to the project

Options
  -h  / --help
  -v  / --verbose
  -vv / --verbose --verbose
  -i  / --info
  -i -p projectname
  -p projectname, / --project projectname 
  --create 
  --kill
  --join,  --nojoin
  --LongName projectname(long)
  --Admins user1,user2,user3, ... 
  --Members user1,user2,user3, ... 
  --MemberGroups group1,group2,group3, ... 
  --MemberProjects project1,project2,project3, ... 
  --AddQuota quotastring
  --AddMailQuota number
  --MaxMembers number

Please see the sophomorix-project(8) man pages for full documentation
');
   print "\n";
   exit;
}





# show the Database Modules that are loaded
#&show_modulename();
#&show_sys_modulename();
&check_connections();



# --info
if ($project eq "" and $info==1){
    &show_project_list();
    exit;
}

# --join
if (not defined $join){
    $p_join="";
} elsif ($join==0) {
    $p_join="FALSE"; 
} elsif ($join==1) {
    $p_join="TRUE";
}

# --mailalias
if (not defined $mailalias){
    $p_mailalias=""; 
} elsif ($mailalias==0){
    $p_mailalias="FALSE"; 
} else {
    $p_mailalias="TRUE";
}

# --maillist
if (not defined $maillist){
    $p_maillist=""; 
} elsif ($maillist==0){
    $p_maillist="FALSE"; 
} else {
    $p_maillist="TRUE";
}


# parse arguments
if (defined $p_long_name) {
   unless ($p_long_name =~ m/^([\w-]+)$/) { 
       print "\nArgument of --LongName contains invalid characters. \n\n";
       exit;
   }
}

if (defined $project) {
   unless ($project =~ m/^([\w-]+)$/) { 
       print "\nArgument of --project contains invalid characters. \n\n";
       exit;
   }
}




# --info --project name
if ($project ne "" and $info==1){
    &show_project($project);
    exit;
}




# ===========================================================================
# Programmbeginn
# ===========================================================================

# repair.directories einlesen
&get_alle_verzeichnis_rechte();


# create/update project
if ($kill==0){
    &create_project($project,$create,$p_long_name,
                    $p_add_quota,$p_add_mail_quota,
                    $p_status,$p_join,$pg_timestamp,
                    $p_max_members,$p_members,$p_admins,
                    $p_groups,$p_projects,
                    $p_mailalias,$p_maillist);
} elsif  ($kill==1){
    # remove all users from project
    # (BEFORE removing project)
    print "Preparin Project to kill (remove users)!\n";
    &create_project($project,0,"",
                    0,0,
                    "K","FALSE",$pg_timestamp,
                    0,"","",
                    "","",
                    0,0);

    # project_details: Eintrag löschen
    # und files loeschen 
    # (BEFORE removing group)
    &remove_project($project);

    # gruppe entfernen
    &remove_class_db_entry($project);
}


# Setting Quota if necessary
if ($Conf::use_quota eq "yes" 
      and (
         defined $p_admins
         or defined $p_groups
         or defined $p_members
         or defined $p_projects
         or defined $p_add_quota
         or defined $p_add_mail_quota
         or $kill==1
        ) 
    ) {
    system("sophomorix-quota --noninteractive");
} else {
    &titel("NOT setting quota (nothing quota related changed)");
}





# Creating Mailing Aliases and Lists
if (defined $p_admins
    or defined $p_groups
    or defined $p_members
    or defined $p_projects
    or defined $p_long_name
    or defined $mailalias
    or defined $maillist
    or $kill==1
   ) {
    system("sophomorix-mail");
} else {
    &titel("NOT creating mailaliases/lists (nothing mail related changed)");
}

