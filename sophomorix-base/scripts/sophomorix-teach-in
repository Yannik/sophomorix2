#!/usr/bin/perl -w
# Dieses Script (sophomorix-teach-in) wurde von Rüdiger Beck erstellt
# Es ist freie Software
# Bei Fehlern wenden Sie sich bitte an mich.
# jeffbeck@web.de  oder  jeffbeck@gmx.de

# ===========================================================================
# Bibliotheken
# ===========================================================================
use strict;
use Getopt::Long;
Getopt::Long::Configure ("bundling");
use Sophomorix::SophomorixBase;
#use Schedule::at;
# Für das Fuzzy-matching
use String::Approx 'amatch';
use Term::ANSIColor qw(:constants); # farbiger Text RED, BLUE, ...
# nach jedem Printbefehl wieder auf Standardfarbe zurücksetzen
$Term::ANSIColor::AUTORESET = 1;

# Einlesen der Konfigurationsdatei für Entwickler
{ package DevelConf ; do "/etc/sophomorix/devel/user/sophomorix-devel.conf"}

# jeffbecks Bibliothek und
# Einlesen der Konfigurationsdatei
#require "${DevelConf::library_pfad}/sophomorix-lib";

# Nur als Dummy(Warnings verhindern)
if($DevelConf::ergebnis_pfad){};
if($DevelConf::dyn_config_pfad){};
if($DevelConf::schueler_oder_user){};
if($DevelConf::library_pfad){};
#if(){};


# ===========================================================================
# Deklarationen
# ===========================================================================

# ===========================================================================
# Aufrufparameter
# ===========================================================================



# Erlaubte Werte in einen Hash schreiben
my %match_fehlertoleranz_erlaubt = qw(
       5     0           10     0
      15     0           20     0
      25     0           30     0
      35     0           40     0
      45     0           50     0
      55     0           60     0
);





# ===========================================================================
# Variablen, ...
# ===========================================================================

my $identifier;

# Hash in die Hinzukommende Schüler eingelesen werden
my %schueler_hinzu_hash;

# Hash für Eintage in der Teach-in-Datei
my %teach_in_hash_alt;
# Key und Value in diesem Hash
my $teachin_im_system;
my $teachin_replace;

# Hash für das Auswahlmenü
my %auswahl_hash;
# Variablen für das Auswahlmenü
my $schueler_weg="";
my $schueler_hinzu="";
my $entsprechungs_nummer=0;
my $user_antwort=0;

# Wiederverwendbare Variablen zur Hashausgabe
my $k;
my $v;





# ===========================================================================
# Optionen verarbeiten
# ==========================================================================

# Variablen für Optionen
my $testen=0;
$Conf::log_level=1;
my $help=0;
my $info=0;
my $clear=0;
# Parameter gibt an wie verschieden ähnliche Schüler finden soll (in Prozent)
# 10% nur sehr änliche Namen werden gefunden
# 25% sinnvoller Wert
# 45% auch Schüler mit vertauschtem Vor- und Nachname werden gefunden
my $match_fehlertoleranz="";;



# Parsen der Optionen
my $testopt=GetOptions(
           "clear|c" => \$clear,
           "approx|a=s" => \$match_fehlertoleranz,
#           "test|t" => \$testen,
#           "verbose|v+" => \$Conf::log_level,
           "help|h" => \$help,
           "info|i" => \$info
          );


# Prüfen, ob Optionen erkannt wurden
&check_options($testopt);


# --help
if ($help==1) {
   # Scriptname ermitteln
   my @list = split(/\//,$0);
   my $scriptname = pop @list;
   # Befehlbeschreibung
   print "$scriptname sucht in hinzukommenden usern und zu löschenden usern\n"; 
   print "nach Ähnlichen. Mit $scriptname können diese User einander zugeordnet werden.\n";
   print "So wird ein korrigierter User-Datensatz unter seinem alten Namen durchgeschleust.\n\n";
   # gemeinsamer Hilfetext
   &help_text_all;

   # optionen
   print "Optionen:\n\n";

   print "  --info, -i\n";
   print "     Gibt den Inhalt der bisherigen teach-in.txt aus.\n\n";

   print "  --clear, -c\n";
   print "     Löscht die Datei teach-in.txt.\n\n";

   print "  --approx, -a\n";
   print "     Gibt an, wie genau es $scriptname nehmen soll bei der Suche nach\n";
   print "     Ähnlichen Usern. Erlaubt sin Werte von 5 bis 60. Der standardwert ist 25.\n";
   print "     Je höher der Wert, desto mehr User werden gefunden.\n\n";



   exit;
}


# --approx
if ($match_fehlertoleranz eq ""){
# Standardwert angeben für das Argument
$match_fehlertoleranz="25";
} else {
   if (exists($match_fehlertoleranz_erlaubt{$match_fehlertoleranz})){# ist im Hash zu finden
           # nix tun
       } else {
           # Abbruch
           print "  Fehlertoleranz $match_fehlertoleranz ist nicht zulässig! \n";
           print "  Zulässige Argumente sind 5 bis 60 \n";
           print "    (in 5-er Schritten) \n";
           die;
       }
}

# --clear
if ($clear==1){
    # Löschen
    print "\nLösche ${DevelConf::config_pfad}/teach-in.txt ...\n";
    system("rm ${DevelConf::config_pfad}/teach-in.txt");
    # Leere Datei anlegen
    &check_datei_touch("${DevelConf::config_pfad}/teach-in.txt");
    # Meldung
    print "Sie müssen nun sophomorix-check aufrufen, und erst dann können\n";
    print "sie einen erneuten teach-in durchführen\n\n";
    exit;
}

# --info
if ($info==1){
    # Ausgabe von teach-in.txt
    open(TEACHIN, "${DevelConf::config_pfad}/teach-in.txt");

    print "\n  Folgende user sind schon in teach-in.txt:\n\n";

    print "Linux-Netzwerk-Identifier                Schulverwaltung-Identifier\n";
    &linie;
    while (<TEACHIN>){
      chomp();
      if(/^\#/){next;} # Bei Kommentarzeichen aussteigen
      ($teachin_im_system,$teachin_replace)=split(/:::/);
      printf "%-40s %3s","$teachin_im_system","$teachin_replace\n";  
    }
    close(TEACHIN);
    exit;
}


# ===========================================================================
# Programmbeginn
# ===========================================================================

# ===========================================================================
# Start-Logo ausgeben
# ===========================================================================

&titel("sophomorix-teach-in startet mit einer Fehlertoleranz von $match_fehlertoleranz %");


# ===========================================================================
# Schüler-Hinzu-Hash erstellen
# ===========================================================================
open(SCHUELERHINZU,
     "${DevelConf::ergebnis_pfad}/sophomorix.add") 
     || die "Fehler: $!";



if($Conf::log_level>=3){
   &titel("Hinzukommen sollen folgende Schüler (Hinzu-Hash):");
 }
   while(<SCHUELERHINZU>){

      chomp();
      if($Conf::log_level>=3){
         print "Lese ein:                  $_\n";
       }
      ($a,$identifier,$a)=split(/::/);
      $schueler_hinzu_hash{$identifier}="hinzu";
#      if($Conf::log_level>=3){
         print "Extrahierter Identifier:   $identifier\n";
#       }
   }



close(SCHUELERHINZU);



# ===========================================================================
# Alter Teach-In-Hash aus teach-in.txt erstellen
# ===========================================================================
open(SCHUELERTEACHIN,
     "<${DevelConf::config_pfad}/teach-in.txt") 
     || die "Fehler: $!";

while(<SCHUELERTEACHIN>){
   chomp();
   if(/^\#/){next;} # Bei Kommentarzeichen aussteigen
   ($teachin_im_system,$teachin_replace)=split(/:::/);
   $teach_in_hash_alt{$teachin_im_system}="$teachin_replace";
}

&titel("Einträge in der bisherigen Datei teach-in.txt:");

print " - Linux-Netzwerk Schreibweise -  :::  - Verwaltung Schreibweise -\n";
print "----------------------------------------",
      "----------------------------------------\n";

while (($k,$v) = each %teach_in_hash_alt) {
print "$k",":::","$v","\n";
}

print "\n";

close(SCHUELERTEACHIN);





# ===========================================================================
# Alle Schüler, die entfernt werden sollen einzeln abfragen
# ===========================================================================

&titel("Der Teach-in beginnt ...");

my @toleration=();


open(TOLERATION,"<${DevelConf::dyn_config_pfad}/user.protokoll");
while(<TOLERATION>){
     my @line=split(/;/);
     if(defined $line[7]){
       if ($line[7]){
         my $gecos=$line[1];
         my ($first,$last)=split(/ /,$gecos);
         my $identifier=$last.";".$first.";".$line[4];
         print $identifier."\n";
         push @toleration, $identifier;
       }	    
     }
}
close(TOLERATION);


foreach $identifier (@toleration){
   # Gesucht wird Entsprechung zu diesem Schüler
   printf "%-25s: %-40s\n" , 
          "Bereits im System ist", 
          "$identifier";
   print "----------------------------------------",
         "----------------------------------------\n";
   # Auswahlnummer auf eins setzen
   $entsprechungs_nummer=0;
   # Bisherige Werte löschen
   $user_antwort="";
   %auswahl_hash=();
   # ======================================================================
   # Auswahlmenü erzeugen
   # ======================================================================
   # Hash mit allen hinzukommenden Schülern durchgehen
   while (($_,$v) = each %schueler_hinzu_hash) {
      chomp();
      $schueler_hinzu=$_;
      # Approx-Match ausgeben
      # 25% ist realistisch für Approx-Matching
 # so tuts:#  if (amatch("$schueler_weg" , ["i 25%"])){
      if (amatch("$identifier" , ["i   ${match_fehlertoleranz}%"])){
         $entsprechungs_nummer++;
         printf "%-25s: %-40s\n" , 
                "($entsprechungs_nummer) Etwaige Entsprechung",
                "$schueler_hinzu";
         # Approx-Match ablegen im Auswahl-Hash
         $auswahl_hash{$entsprechungs_nummer}="$schueler_hinzu";
      }
   }# Alle Schüler durchgegangen
   # (0) = Nichts machen hinzufügen zum Auswahl-Hash
   printf "%-25s: %-40s\n" , 
          "(0)",
          "Nichts tun";
          $auswahl_hash{0}="Nichts tun!";
   print "----------------------------------------",
         "----------------------------------------\n";

   # ======================================================================
   # Useraktion einlesen
   # ======================================================================
   if($entsprechungs_nummer==0){
   # Es gibt nur 0=Nichts tun
   $user_antwort="0";
   } else { # Admin nach rat fragen
      while(){# Endlosschleife für die Eingabe
         $user_antwort= <STDIN>; # Lesen von Tastatur
         chomp($user_antwort); # Newline abschneiden
         if (exists($auswahl_hash{$user_antwort})){
            # Wenn Eingabewert im Auswahl-Hash vorkommt, aussteigen
            last; # Ausstieg aus Endlosschleife
         } else {
            # Endlosschleife, Eingabe wiederholen
            print "Fehlerhafte Eingabe. Bitte wiederholen! Zuerst die Ziffer, dann <RETURN>\n";
         }
      }
    }
   # ======================================================================
   # Resultat der Useraktion verarbeiten
   # ======================================================================
   print "========================================",
         "========================================\n";
   print "Speichere:  ", 
         "$identifier",
         ":::",
         "$auswahl_hash{$user_antwort}\n";
   print "========================================",
         "========================================\n\n\n\n";
   # Ausgabe in die tech-in-datei
   if ($user_antwort eq "0"){ # nur, wenn 1,2,3,... gewählt etwas tun
      # Nichts tun
   } else {
      # Wenn Eintrag im Hash_alt vorhanden, erstmal löschen
      if (exists($teach_in_hash_alt{$identifier})){
         # Dann den Eintrag löschen
         delete($teach_in_hash_alt{$identifier});
      } 
      # Eintrag neu schreiben (mit evtl. verändertem Wert)
      $teach_in_hash_alt{$identifier}="$auswahl_hash{$user_antwort}";
   }
}

#close(DULDUNG);
   

# ===========================================================================
# Modifizierten Teach-in-Hash-alt nach teach-in.txt schreiben
# ===========================================================================
open(SCHUELERTEACHIN,
     ">${DevelConf::config_pfad}/teach-in.txt") 
     || die "Fehler: $!";

# Kommentar einfügen !muss in sophomorix-check auch angepasst werden!
print SCHUELERTEACHIN "# sophomorix-Konfigurationsdatei\n";
print SCHUELERTEACHIN "# Alle Kommentare -außer den jetzt sichtbaren- werden wieder entfernt!\n";
print SCHUELERTEACHIN "# Editieren Sie diese Datei nur, wenn sie wissen, was sie tun!\n";
print SCHUELERTEACHIN "# Linux-Netzwerk Schreibweise ::: Verwaltung Schreibweise:\n";
print SCHUELERTEACHIN "# ---------------------------------------",
                   "---------------------------------------\n";
# Einträge schreiben
while (($k,$v) = each %teach_in_hash_alt) {
print SCHUELERTEACHIN "$k",":::","$v","\n";
}
close(SCHUELERTEACHIN);



# ===========================================================================
# Ende Logo ausgeben
# ===========================================================================

&titel("... sophomorix-teach-in beendet sich jetzt.");

