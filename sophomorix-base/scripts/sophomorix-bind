#!/usr/bin/perl -w
# $Id$
# This script (sophomorix-bind) is maintained by Rüdiger Beck
# It is Free Software (License GPLv3)
# If you find errors, contact the author
# jeffbeck@web.de  or  jeffbeck@gmx.de


# ????? is homedir absolute 
# ????? binds nicht automatisch anlegen (option in sophomorix-devel.conf)
# ????? man page anlegen

# Bibliotheken
use strict;
use Getopt::Long;
use Sophomorix::SophomorixConfig;
use Sophomorix::SophomorixBase;
use Sophomorix::SophomorixAPI;
use Sophomorix::SophomorixPgLdap;
Getopt::Long::Configure ("bundling");
use DBI;
use Sophomorix::SophomorixPgLdap qw(show_modulename
                                   );
my @arguments = @ARGV;

# Scriptname ermitteln
my @list = split(/\//,$0);
my $scriptname = pop @list;


my $help=0;
my $info=0;
my $user="";
my $homedir="";
my $host="";
my $login=0; 
my $logout=0;


###############################################################################
# Beginn
###############################################################################


# Parsen der Optionen
my $testopt=GetOptions(
           "help|h" => \$help,
           "info|i" => \$info,
           "login" => \$login,
           "logout" => \$logout,
           "verbose|v+" => \$Conf::log_level,
           "host:s" => \$host,
           "user:s" => \$user,
           "homedir:s" => \$homedir,
          );


# Prüfen, ob Optionen erkannt wurden
&check_options($testopt);



# --help
if ($help==1) {
   # Befehlbeschreibung
   print "\n$scriptname creates bind mounts to share directories",
         "\non samba login or logout(Replaces links)\n";

   print('
Options
  -h  / --help
  -v  / --verbose
  -vv / --verbose --verbose
  --login | --logout
  --user username
  --homedir /homedir/of/user
  --host host

Please see the sophomorix-bind(8) man pages for full documentation
');
   print "\n";
   exit;
}



print "User:    $user\n";
print "Homedir: $homedir\n";
print "Host:    $host\n";

if ($login==1 and $logout==0){
    # login
    print "Type:    LOGIN\n";
    # run login script
    my $command="/usr/sbin/sophomorix-repair --user $user --repair-binds \"\"";
    print "  * $command\n";
    system($command);
} elsif ($login==0 and $logout==1){
    # logout
    print "Type:    LOGOUT\n";
    if ($host eq "127.0.0.1"){
        # horde, ...
        print "  * Doing nothing on logout from $host\n";
    } else {
        # run logout script
        my $command="/usr/sbin/sophomorix-repair --user $user --delete-binds \"\"";
        print "  * $command\n";
        system($command);
    }
} else {
    print "\nYou must use:\n";
    print "\n   --login OR --logout\n\n";
    exit;
}



