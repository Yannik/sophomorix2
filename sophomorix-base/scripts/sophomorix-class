#!/usr/bin/perl -w
# Dieses Script (sophomorix-class-dbi) wurde von Rüdiger Beck erstellt
# Es ist freie Software
# Bei Fehlern wenden Sie sich bitte an mich.
# jeffbeck@web.de  oder  jeffbeck@gmx.de


# ===========================================================================
# Bibliotheken
# ===========================================================================
use strict;
use Getopt::Long;
Getopt::Long::Configure ("bundling");
use Sophomorix::SophomorixConfig;
use Sophomorix::SophomorixBase;
use Sophomorix::SophomorixAPI;
use Sophomorix::SophomorixPgLdap;
use DBI;
#use Schedule::at;

# ===========================================================================
# Optionen verarbeiten
# ==========================================================================
# Variablen für Optionen
$Conf::log_level=1;
my $help=0;
my $info=0;
my $class="";
my $quota="";
$Conf::log_level=1;

# Parsen der Optionen
my $testopt=GetOptions(
           "help|h" => \$help,
           "info|i" => \$info,
           "class|c=s" => \$class,
           "quota|q=s" => \$quota,
           "verbose|v+" => \$Conf::log_level,
          );

# Prüfen, ob Optionen erkannt wurden
&check_options($testopt);

# --help
if ($help==1) {
   # Scriptname ermitteln
   my @list = split(/\//,$0);
   my $scriptname = pop @list;
   # Befehlbeschreibung
   print('
sophomorix-class-dbi adds projects to the sophomorix database and adds users
   or groups as members to the project

Options
  -h  / --help
  -v  / --verbose
  -vv / --verbose --verbose
  -i  / --info
  -c AdminClass, / --class AdminClass 
  -q value / --quota value
Please see the sophomorix-class-dbi(8) man pages for full documentation
');
   print "\n";
   exit;
}

############################################################
# config values
############################################################

my $dbh=&db_connect();


#my $dbh = DBI->connect("DBI:CSV:f_dir=${DevelConf::protokoll_pfad};csv_eol=\n;"
#                      . "csv_sep_char=\\;csv_quote_char=;"
#                      . "csv_escape_char=;skip_first_row");

#$dbh->{'csv_tables'}->{'class_db'} = {
#        'col_names' => ["AdminClass", "Department", "Type", "Mail", "Quota"]
#           };


my $sth;


# select something

#$sth = $dbh->prepare("SELECT * FROM class_db WHERE AdminClass LIKE 'wg1%' ");



# --info
if ($info==1){

   $sth = $dbh->prepare("SELECT * FROM classdata");
   
   $sth->execute();

   print "\n";
   printf "%-13s %-11s %-10s %-4s %-11s \n",
          "AdminClass", "Quota", "SchoolType" , "Mail", "Department";

   print "=======================================",
         "=======================================\n";
   while (my $row = $sth->fetchrow_hashref) {
 
       printf "%-13s %-11s %-10s %-4s %-11s\n",
              $row->{'gid'}, 
              $row->{'quota'},
              $row->{'schooltype'},
              $row->{'mailalias'},
              $row->{'department'}; 
    }
    $sth->finish();
    print "\n";
}







# --info
if ($quota ne "" and $class ne ""){
    # fetch id of admin_class
    my ($gid_sys,$id)= $dbh->selectrow_array( "SELECT gidnumber,id
                                         FROM groups 
                                         WHERE gid='$class'" );
    print "Updating quota of AdminClass $class (gidnumber=$gid_sys,id=$id)",
          " to $quota ...";
    $dbh->do("UPDATE class_details SET quota = '$quota' WHERE id = $id ");
    print "    done.\n";
}



