#!/usr/bin/perl -w
# $Id$
# Dieses Script (sophomorix-vampire) wurde von Rüdiger Beck erstellt
# Es ist freie Software
# Bei Fehlern wenden Sie sich bitte an mich.
# jeffbeck@web.de  oder  jeffbeck@gmx.de


# Einlesen der Konfigurationsdatei für Entwickler
#{ package DevelConf ; do "/etc/sophomorix/devel/user/sophomorix-devel.conf"}


# Bibliotheken
use strict;
use Quota;
use Getopt::Long;
Getopt::Long::Configure ("bundling");
use Sophomorix::SophomorixConfig;
use Sophomorix::SophomorixBase;
use Sophomorix::SophomorixAPI;

use Sophomorix::SophomorixPgLdap qw(show_modulename
                                   );
use DBI;

my $server_key_location="";
my $command="";
my $fetch_files=0;
my $install_files=0;

my $help=0;
my $clear=0;
my $server="";
my $sync_user=0;
my $sync_homes=0;
my $sync_dirs=0;
my $sync_shares=0;
my $configure_quota=0;
my $update_quota=0;
my $mlscripts=0;
my $key=0;

my $loginname="";
my $classes="";
my $projects="";
my $student=0;
my $rooms="";
my $ws=0;
my $force=0;
my @userlist=();
my $dir_old_files="/root/sophomorix-vampire/";
my $dir_config_files="/root/sophomorix-vampire-config/";
my $old_ws_file=$dir_old_files."wimport_data";

my $old_version="2.x";


# Parsen der Optionen
my $testopt=GetOptions(
           "help|h" => \$help,
           "clear" => \$clear,
           "server=s" => \$server,
           "sync-users" => \$sync_user,
           "configure-quota" => \$configure_quota,
           "update-quota" => \$update_quota,
           "sync-homes" => \$sync_homes,
           "sync-dirs" => \$sync_dirs,
           "sync-shares" => \$sync_shares,
           "mlscripts" => \$mlscripts,
           "key" => \$key,
           "fetch-files" => \$fetch_files,
           "install-files" => \$install_files,
           "user|u=s" => \$loginname,
           "class|c=s" => \$classes,
           "project|projects|p=s" => \$classes,
           "student|students" => \$student,
           "room|=s" => \$rooms,
           "workstations|workstation|ws" => \$ws,
           "force" => \$force,
          );

# Prüfen, ob Optionen erkannt wurden, sonst Abbruch
&check_options($testopt);

# --help
if ($help==1) {
   # Scriptname ermitteln
   my @list = split(/\//,$0);
   my $scriptname = pop @list;
   # Befehlsbeschreibung
   print('
sophomorix-vampire sucks all data from an old linux-ml-server and uses it

PLEASE READ THE MANPAGE FOR INFORMATION

THIS IS OUTDATED

Options
  -h  / --help
  -v  / --verbose
  -vv / --verbose --verbose
  -i  / --info
  --server name / --server ip 
  --clear
  -u user1 / --user user1
  -c class / --class class 
  --pupils
  -r room / --room room
  --workstations

  --mlscripts sync remboinit.rbc files of used hardwareclasses

Please see the sophomorix-vampire(8) man pages for full documentation
');
   print "\n";
   exit;
}


if ($server eq ""){
    # try to fetch server ip
    if (-e "${DevelConf::vampire_path}/server"){
       open (SERVER, "<${DevelConf::vampire_path}/server");
       while (<SERVER>){
	   chomp();
           $server=$_;
       }
       close(SERVER);
       print "* Using $server from ${DevelConf::vampire_path}/server as Server-IP\n";
    } else {
       # no IP available -> Error Message
       print "You must tell me which server I shall suck data from!\n";
       exit;
    }
} else {
    # save the server ip
    system("install -d ${DevelConf::vampire_path}");
    open (SERVER, ">${DevelConf::vampire_path}/server");
    print SERVER $server;
    close(SERVER);
}




############################################################
# Create userlist
############################################################
if ($loginname ne ""){
      @userlist=($loginname);
} else {
   if ($force==1){
       @userlist=&create_userlist($loginname,$classes,0,
                                  $projects,0,$student,
                                  $rooms,$ws,0);
   } else {
       # check the users
       @userlist=&create_userlist($loginname,$classes,0,
                                  $projects,0,$student,
                                  $rooms,$ws,1);
   }
}

if ($#userlist+1==0){
     print "INFO: No valid users given\n";
     $help=1;
}





############################################################
# Step 1: put a key on the server to be sucked out
############################################################

my $key_dsa="/root/.ssh/vampire_key_dsa";

if ($key==1) {
    # generate key
    print "* Step 1:  copying a key to a server\n";
    print "Generating a key ...\n";
    system("/usr/bin/ssh-keygen -f ${key_dsa} -t dsa -N ''");
    # copy key
    print "Copying public key to other server...\n";
    $command="ssh-copy-id -i ${key_dsa}.pub root\@${server}";
    system("$command");
}


############################################################
# Step 2: fetch some files
############################################################

system("mkdir -p $dir_config_files");

if ($clear==1) {
    print "Fetching configuration data once again.\n";
    system("rm -rf $dir_old_files");
    system("mkdir $dir_old_files");
    $fetch_files=1,
} elsif (not -e $dir_old_files){
    system("mkdir $dir_old_files");
}

if ($fetch_files==1){
    print "* Step 2:  fetching files to ${dir_old_files}\n";
    # reading the list of files to fetch from the old server
    my @files=&get_conf_lines("vampire_${old_version}_files");
    #foreach my $file (@files){
    #   print $file,"\n";
    #}
    foreach my $file (@files){
       $command="scp -i $key_dsa root\@${server}:$file $dir_old_files";
       print "\nFetching  $file ...\n";
       system("$command");
    }
    # rename some files
    system("mv $dir_old_files/schulinfo.txt $dir_old_files/class_db");
    system("mv $dir_old_files/user.protokoll $dir_old_files/user_db");
}



############################################################
# Step 3: install/patch some files
############################################################
if ($install_files==1){
    print "* Step 3:  install/patch configuration files from $dir_old_files\n";
    # schueler.txt
    print "   * copying schueler.txt\n";
    system("cp ${dir_old_files}/schueler.txt ${DevelConf::users_pfad}/schueler.txt");
    # lehrer.txt
    print "   * copying/patching lehrer.txt\n";
    # open infile and out file
    open (IN, "<${dir_old_files}/lehrer.txt");
    open (OUT, ">${DevelConf::users_pfad}/lehrer.txt");
    my $patched="";
    while (<IN>){
        chomp();
        if(/^\#/){
            $patched=$_;
        } else {
            my ($group,$last,$first,$birth,
                $login,$pass,$usertoken,$quota)= split(/;/);

            # replace kurz with usertoken
            if ($usertoken=~/kurz/){
                $usertoken=~s/kurz/usertoken/;
            }     

            # set standard quota for every teacher
            $quota="quota";

            $patched = $group.";".$last.";".$first.";".$birth.";".
                       $login.";".$pass.";".$usertoken.";".$quota.";";

        }
        #print $patched."\n";
	print OUT $patched."\n";
    }
    close(IN);
    close(OUT);

    # extraschueler.txt
    print "   * copying/patching  extraschueler.txt\n";
    system("cp ${DevelConf::config_template_pfad}/extraschueler.txt ${DevelConf::users_pfad}/extraschueler.txt");
    system(" echo '###\n### Lines from here are entrys from an update of $server with sophomorix-vampire\n###' >> ${DevelConf::users_pfad}/extraschueler.txt");
    system("cat ${dir_old_files}/extraschueler.txt >> ${DevelConf::users_pfad}/extraschueler.txt");
    # extrakurse.txt
    print "   * copying/patching  extrakurse.txt\n";
    system("cp ${DevelConf::config_template_pfad}/extrakurse.txt ${DevelConf::users_pfad}/extrakurse.txt");
    system(" echo '###\n### Lines from here are entrys from an update of $server with sophomorix-vampire\n###' >> ${DevelConf::users_pfad}/extrakurse.txt");
    system("cat ${dir_old_files}/extrakurse.txt >> ${DevelConf::users_pfad}/extrakurse.txt");
 

    # workstations
    # open infile and out file
    open (IN, "<${dir_old_files}/wimport_data");
    open (OUT, ">/etc/linuxmuster/wimport_data_patched");
    my $patched_ws="";
    while (<IN>){
        chomp();

        if(/^\#/ 
           or $_ eq ""){
            $patched_ws=$_;
        } else {
            my ($room,$host,$hwk,$mac,$ip,$netmask,
                $part1,$part2,$part3,$part4,$pxe,$type)= split(/;/);

	    if (not defined $type){
                $type="";
            }

            if ($pxe eq "20"){
                $pxe="22";
            }

            $patched_ws = $room.";".$host.";".$hwk.";".$mac.";".$ip.";".$netmask.";".
		$part1.";".$part2.";".$part3.";".$part4.";".$pxe.";".$type.";";

        }
        print $patched_ws."\n";
	print OUT $patched_ws."\n";
    }
    close(IN);
    close(OUT);

    # pxe 20 -> 22 ?
    # netmask anpassen
    # ip anpassen

}



############################################################
# Step 4: sync some dirs
############################################################


if ($sync_dirs==1){
    my @dirs=&get_conf_lines("vampire_${old_version}_dirs");
    #foreach my $dirline (@dirs){
    #   print $dirline,"\n";
    #}
    print "* Step 4:  synchronizing other dirs\n";
    &rsync_dirs(@dirs);
}



############################################################
# Step 5: sync the users
############################################################
if ($sync_user==1){
   print "* Step 5:  synchronizing users\n";
   system("sophomorix-check --no-auto-teach-in --get-info-from-old-files ${dir_old_files}");
   if ($classes ne ""){
       my $command="sophomorix-add -c $classes";
       print "\nCalling: $command \n\n";
       system("$command");
   } elsif ($loginname ne ""){
       my $command="sophomorix-add -u $loginname";
       print "\nCalling: $command \n\n";
       system("$command");
   } else {
       # alles
       my $command="sophomorix-add";
       print "\nCalling: $command \n\n";
       system("$command");
   }
   system("sophomorix-move");
}



############################################################
# Step 6: configure quota
############################################################
    my %quota_map=();
    my %new_quota_teacher=();
    my %new_quota_classes=();

    my $mailquota_map=-1;  
    my $new_mailquota_teacher=-1;
    my $new_mailquota_classes=-1;



if ($configure_quota==1){
    print "* Step 6:  configure quota\n";

# configure start
    # map old to new quota
    $quota_map{0}=1;
    #$quota_map{1}=0;
    # set new quota
    $new_quota_teacher{1}=101;
    #$new_quota_teacher{3}=2033;

    $new_quota_classes{1}=150;

    # mailquota
    # quota value to use for mailquota
    $mailquota_map=0;
    # set new_mailquota for teachers
    $new_mailquota_teacher=-1;
    $new_mailquota_classes=8;
# configure end


    # teacher.txt
    print "   * copying/patching lehrer.txt\n";
    open (IN, "<${dir_old_files}/lehrer.txt");
    open (OUT, ">${DevelConf::users_pfad}/lehrer.txt");
    my $patched_lq="";
    while (<IN>){
        chomp();
        if(/^\#/){
            $patched_lq=$_;
        } else {
            my ($group,$last,$first,$birth,
                $login,$pass,$usertoken,$quota,$mailquota)= split(/;/);

            # remove whitespace
            $quota=~s/ //g;

            if ($quota=~/quota/){
               # do nthing
            } else {
               ($quota,$mailquota)=&configure_quota($quota,$mailquota,"teacher"); 
            }    

            $patched_lq = $group.";".$last.";".$first.";".$birth.";".
                       $login.";".$pass.";".$usertoken.";".$quota.";".$mailquota.";";
        }
	print OUT $patched_lq."\n";
    }
    close(IN);
    close(OUT);

    # info from class_db (schulinfo.txt)
    my $class_command="";
    print "   * scheduling the following commands:\n";
    open (CLASS, "<${dir_old_files}/class_db");
    open (COMMANDS, ">${dir_config_files}/quota.commands");
    while (<CLASS>){
        chomp();
        if(/^\#/){
            next;
        } else {
            my $mailquota="";
            my ($class,$abt,$type,$m,$quota)= split(/;/);

            # remove whitespace
            $quota=~s/ //g;

            if ($quota=~/quota/){
               # do nothing
            } else {
               ($quota,$mailquota)=&configure_quota($quota,$mailquota,"classes"); 
               $class_command="sophomorix-class --class $class --quota $quota --mailquota $mailquota";
               print "     * $class_command\n";
               print COMMANDS "$class_command\n";
            }    
        }
    }
    close(CLASS);
    close(COMMANDS);
}


############################################################
# Step 7: update quota
############################################################
if ($update_quota==1){
    print "* Step 7:  update quota in the system\n";
    system("sophomorix-check");
    system("source ${dir_config_files}/quota.commands");
    system("sophomorix-quota");
}



############################################################
# Step 8: synchronize the user homes
############################################################
if ($sync_homes==1){
   print "* Step 8:  synchronizing user homes\n";
   &print_list_column(6,"Userlist for synchronising \$HOME",@userlist);
   # do this for all users
   foreach my $user (@userlist){
     my $old_home="";
     my $new_home="";
     my $command="";
     # look up homes in old passwd
     open(OLD, "<${dir_old_files}/passwd");
     while (<OLD>){
	my @list=split(/:/);
        if ($list[0] eq $user){
            $old_home=$list[5]."/";            
        }
     }
     close(OLD);

     # look up new homes  in passwd
     setpwent();
     while (my @list=getpwent()) {
        if ($list[0] eq $user){
            #print "$list[7]\n";
            $new_home=$list[7]."/";
        }
     }
     endpwent();

     my ($group) = &Sophomorix::SophomorixPgLdap::pg_get_group_list($user);

     # rsync all homes
     print "\n";

     system("mkdir -p $new_home/old_data");
     system("chown ${user}:${group} $new_home/old_data");
     system("chmod 700 $new_home/old_data");

     # windows
     system("mkdir -p $new_home/old_data/windows");

     # linux
     system("mkdir -p $new_home/old_data/linux");
 
     # mail mbox 2.x only
     system("mkdir -p $new_home/old_data/mail");


     # different 2.x and 3.0 ?????

     {
     # windows
     my $source="${old_home}windows";
     my $target="${new_home}old_data";
     &titel("Synchronizig home of user $user (windows):");
     print "   $source \n     --> $target\n";
     $command="/usr/bin/rsync -e \"ssh -i $key_dsa\" -av --delete  root\@${server}:$source $target";
     print "$command\n";
     system($command); 
     system("chown -R ${user}:${group} $new_home/old_data/windows");
     system("chmod 700 $new_home/old_data/windows");



     # linux
     my $lin_source="$old_home";
     my $lin_exclude="windows/";
     my $lin_target="${new_home}old_data/linux";

     print "   $lin_source \n     --> $lin_target\n";
     $command="/usr/bin/rsync -e \"ssh -i $key_dsa\" -av --delete  --exclude $lin_exclude root\@${server}:$lin_source $lin_target";
     print "$command\n";
     system($command); 
     system("chown -R ${user}:${group} $new_home/old_data/linux");
     system("chmod 700 $new_home/old_data/linux");

     # mail    
     my $mail_source="/var/spool/mail/${user}";
     my $mail_target="${new_home}old_data/mail/${user}";
     #system("scp -i $key_dsa root\@${server}:${mail_source} $mail_target");
     $command="/usr/bin/rsync -e \"ssh -i $key_dsa\" -av root\@${server}:$mail_source $mail_target";
     print "$command\n";
     system($command); 
     system("chown ${user}:${group} $new_home/old_data/mail");
     system("chmod 700 $new_home/old_data/mail");
     system("chown ${user}:${group} $mail_target");

     # mail .forward kopieren
     $command="scp -i $key_dsa root\@${server}:${old_home}.forward $new_home";
     print "$command\n";
     system($command); 
     system("chown ${user}:${group} ${new_home}.forward");
     }

    # repair directories
    # needed to correct permissions owner www-run becomes www-data, ...

    # sync mail (the dir in /var/spool/mail) 
   }
}


# what about horde database content?


############################################################
# Step 9: sync/add the workstations
############################################################

# copy the wimport_data to the new location
# (convert it if necessary)

# sync data is not necessary




############################################################
# Step 10: synchronize the shares
############################################################
if ($sync_shares==1){
    my @classes=();
    if ($classes eq ""){
        @classes=&Sophomorix::SophomorixPgLdap::fetchadminclasses_from_school();
    } else {
        @classes=split(/,/,$classes);
    }

    my %old_id_old_group=();
    open(OLDGROUP, "${dir_old_files}group");
    while(<OLDGROUP>) {
	my ($name,$empty,$gid)=split(/:/);
        $old_id_old_group{$name}=$gid;
    }
    close(OLDGROUP);
    #while(my ($key, $value) = each(%old_id_old_group)) {
    #    # do something with $key and $value
    #    print "$key    $value \n";
    #}

    # create old_id new_group hash
    my %new_group_old_id=();
    # add teacher
    $new_group_old_id{$DevelConf::teacher}=$old_id_old_group{"lehrer"};
    my @groups=&Sophomorix::SophomorixPgLdap::fetchadminclasses_from_school();
    foreach my $group (@groups){
        my $old_group="k".$group;
        my $old_id;
        if (defined $old_id_old_group{$old_group}){
            $old_id=$old_id_old_group{$old_group};
        } else {
            $old_id=0;
        }
        #print "New Group: $group Old Group: $old_group\n";
        #print "   Old id of $group  $old_id \n";
        $new_group_old_id{$group}="$old_id"; 
    }

    print "* Step 10:  synchronizing the shares\n";
    #my $group="m3kb2t";
    # do this for all groups
    foreach my $group (@classes){
       # in 3.x no k before class ???
       my $old_share="/home/tausch/klassen/k$group/*";
       my $new_share="/home/share/classes/$group/";
       my $command="/usr/bin/rsync -e \"ssh -i $key_dsa\" -avg --delete  root\@${server}:$old_share $new_share";
       print "$command \n";
       system($command);

       # fix groupowner
       my @grouplist=(${DevelConf::teacher},$group);
       print "\nFixing groupowner\n";
       foreach my $group_to_check (@grouplist){
           if (defined $new_group_old_id{$group_to_check}){
               $command="find $new_share -group $new_group_old_id{$group_to_check}".
                        " -print0 | xargs -0 chown :${group_to_check}";
               print "\n$command :\n";
               system("$command");
           } else {
               print "WARNING: Could not find old id of $group_to_check \n";
           }
       }
    }
}




############################################################
# synchronize the school share
############################################################


############################################################
# rsync dirs im /etc/sophomorix/vampire/vampire_x.x_dirs
############################################################



if ($mlscripts==1){
    print "* Step 11:  mlscripts stuff (rembo interface)\n";

    # copying mac files
    my $old_hosts="/usr/local/rembo/files/global/hosts";
    my $new_hosts="/var/lib/rembo/files/global/hosts";
    my $rsync_command="/usr/bin/rsync -e \"ssh -i $key_dsa\" -av --exclude .* root\@${server}:$old_hosts $new_hosts";

    print "$rsync_command\n";
#    system("$rsync_command");


    # copying remboinit.rbc
    my $old_ml_dir="/usr/local/rembo/files/global/groups";  
    my $new_ml_tmp_dir=$dir_old_files."mlscripts";  
    my $new_ml_dir="/var/lib/rembo/files/global/groups";  

    my $filename="remboinit.rbc";

    system("mkdir -p $new_ml_dir");
    system("mkdir -p $new_ml_tmp_dir");

    my $replace= " -e 's/\\/mlscripten\\//\\/mlscripts\\//g'"; 

    my @hw=&fetch_hw_classes();
    foreach my $hwc (@hw){
        print "Working on Hardware class $hwc \n";

        my $old_dir=$old_ml_dir."/".$hwc;
        my $new_dir_tmp=$new_ml_tmp_dir."/".$hwc;        
        my $new_dir=$new_ml_dir."/".$hwc;        

        my $command="scp -i $key_dsa root\@${server}:$old_dir/$filename $new_dir_tmp/$filename";
        my $command_sed="sed $replace $new_dir_tmp/$filename > $new_dir/$filename"; 

	print "$command\n";
	print "$command_sed\n";

        # do it!
        system("mkdir -p $new_dir_tmp");
        system("mkdir -p $new_dir");
        system($command);
    
        # modify files and put them into place
        system($command_sed);

    }

}






############################################################
# sub
############################################################
sub configure_quota {
    my ($old_quota,$old_mailquota,$type) = @_;
    #print "OLD: ---$old_quota---\n";
    #print "OLDMAIL: ---$old_mailquota---\n";


    my @old_quota=split(/\+/,$old_quota);
    my @new_quota=();
    my $new_mailquota="mailquota";

    

    # process quota map
    while(my ($new, $old) = each(%quota_map)) {
        $new_quota[$new]=$old_quota[$old];
    }

    # process new quota
    if ($type eq "teacher"){
        while(my ($new, $value) = each(%new_quota_teacher)) {
            $new_quota[$new]=$value;
        }
    } elsif ($type eq "classes"){
        while(my ($new, $value) = each(%new_quota_classes)) {
            $new_quota[$new]=$value;
        }
    }


    my $new_quota=join("+",@new_quota);

    # process mailquota map
    if ($mailquota_map!=-1){
        $new_mailquota=$old_quota[$mailquota_map];
    }
    if ($new_mailquota_teacher!=-1){
        $new_mailquota=$new_mailquota_teacher;
    }


    # process new mailquota 


    #print "NEW: ---$new_quota---\n";
    #print "NEWMAIL: ---$new_mailquota---\n";

    return ($new_quota,$new_mailquota);
}


sub fetch_hw_classes {
    my @hw_classes=();
    my %hw_classes=();
   open (WORKSTATIONS,"<$old_ws_file");
   while (<WORKSTATIONS>){
      chomp();
      if (m/^\#/){
          next;
      }

      my ($room,$host,$hwk,$mac,$ip,$netmask,
          $part1,$part2,$part3,$part4,$pxe,$type) = split(/;/);
      if (not defined $host){
         next;
      }
      if ($pxe eq "0"){
         next;
      }
      # add to hash if not there already
      if (not exists $hw_classes{$hwk}){
          #print "added $hwk\n";
          $hw_classes{$hwk}="dummy";
      }
   }
   close (WORKSTATIONS);

   while(my ($key, $value) = each(%hw_classes)) {
      # do something with $key and $value
      #print "$key    $value \n";
      push @hw_classes, $key;
   }
   @hw_classes = sort @hw_classes;
   return @hw_classes;
}


sub rsync_dirs {
    my @dirlist = @_;
    foreach my $entry (@dirlist){
        my ($old,$new)=split(/::/,$entry);
        print"  - OLD: $old\n",
             "    NEW: $new\n";
        $command="/usr/bin/rsync -e \"ssh -i $key_dsa\" -avz --delete  root\@${server}:$old $new";
#        print "$command\n";
#       system($command); 
    }
}


sub get_conf_lines {
    my ($name) = @_;
    
    my $file = "${DevelConf::vampire_conf}/${name}";
    print "\n### Reading List of files from ${DevelConf::vampire_conf}/${name}\n";
    my @filelist = ();
    open(FILES,"<$file") || die "Cannot open $file: $!";
    while (<FILES>){
	chomp();
        s/^ //g; # Leerzeichen am Zeilenangfang entfernen
        if(/^\#/ or $_ eq ""){ # # am Anfang bedeutet Kommentarzeile
          next;
        }      
        push @filelist, $_;
    }
    close(FILES);
    return @filelist;
}



