#!/usr/bin/perl -w
# Dieses Script (sophomorix-test) wurde von Rüdiger Beck erstellt
# Es ist freie Software
# Bei Fehlern wenden Sie sich bitte an mich.
# jeffbeck@web.de  oder  jeffbeck@gmx.de

# Bibliotheken

use strict;
use Getopt::Long;
use Sophomorix::SophomorixBase;
use Sophomorix::SophomorixFiles;
use Sophomorix::SophomorixTest;
use Test::More "no_plan";
Getopt::Long::Configure ("bundling");

# Einlesen der Konfigurationsdatei für Entwickler
{ package DevelConf ; do "/etc/sophomorix/devel/user/sophomorix-devel.conf"}


system("install -d /root/sophomorix-test");


# ===========================================================================
# Optionen verarbeiten
# ==========================================================================
my $add=0;
my $remove=0;

# Parsen der Optionen
my $testopt=GetOptions(
                "add" => \$add,
    "remove|delete" => \$remove,
          );


# Prüfen, ob Optionen erkannt wurden
&check_options($testopt);


############################################################
# Start
############################################################

my @userlist=(
  "lehrer;Gallilei;Gallileo;12.10.1982;==.*;gallileo gallilei;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982",
  "12C;Thurau;Dietrich;12.10.1982;==.*;dietrich thurau;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982",
  "12C;Bartali;Gino;14.12.1972;==.*;gino bartali;[a-z0-9]{2,};[a-z0-9]{3,};14.12.1972",
  "12C;Coppi;Fausto;12.01.1972;==.*;fausto coppi;[a-z0-9]{2,};[a-z0-9]{3,};12.01.1972",
  "12C;Merckx;Eddy;12.01.1972;==.*;eddy merckx;[a-z0-9]{2,};[a-z0-9]{3,};12.01.1972",
  "12C;Raas;Jan;12.01.1972;==.*;jan raas;[a-z0-9]{2,};[a-z0-9]{3,};12.01.1972",
  "12C;De Vlaminck;Roger;12.01.1972;==.*;roger devlaminck;[a-z0-9]{2,};[a-z0-9]{3,};12.01.1972",
  "12C;Hinault;Bernard;12.01.1972;==.*;bernard hinault;[a-z0-9]{2,};[a-z0-9]{3,};12.01.1972",
  "12C;Kübler;Ferdi;12.01.1972;==.*;ferdi kuebler;[a-z0-9]{2,};[a-z0-9]{3,};12.01.1972",
);


my $user="";
my $today=`date +%d.%m.%Y`;
print "\nToday is $today";
chomp($today);
my $verbose=0;




###########################################################################
# Do I have to add some users?

if ($add==1 and not -e "/root/sophomorix-test/bunchofusers"){
    print '
###########################################################################
#                                                                         #
#                    ANLEGEN EINIGER SCHÜLER, LEHRER                      #
#                                                                         #
###########################################################################
    ';
    foreach $user (@userlist){
       my ($txt,$proto)=split(/==/, $user);
       print "TXT       :  $txt \n";
       print "PROTOKOLL :  $proto \n";
       &append_line("$txt","${DevelConf::users_pfad}/schueler.txt");
    }


    &run_command("sophomorix-check",$verbose);
    &run_command("sophomorix-add",$verbose);


    foreach $user (@userlist){
       my ($txt,$proto)=split(/==/, $user);
       print "TXT       :  $txt \n";
       print "PROTOKOLL :  $proto \n";
       my $login=&get_login_name("$proto");
       &check_account($login,"enabled");
    }

    # Marking the added users
    system("touch /root/sophomorix-test/bunchofusers");
} elsif ($add==1 and -e "/root/sophomorix-test/bunchofusers"){
    print "The users are added already!\n";
} else {
    print "Not adding users!\n";
}


###########################################################################
# Do I have to remove some users?


if ($remove==1 and -e "/root/sophomorix-test/bunchofusers"){
    print '
###########################################################################
#                                                                         #
#                ENTFERNEN ANGELEGTER SCHÜLER, LEHRER                     #
#                                                                         #
###########################################################################
    ';

    foreach $user (@userlist){
        my ($txt,$proto)=split(/==/, $user);
        &remove_line(
                "$txt",
                "${DevelConf::users_pfad}/schueler.txt");
    }

    &run_command("sophomorix-check",$verbose);

    foreach $user (@userlist){
        my ($txt,$proto)=split(/==/, $user);
        my $login=&get_login_name("$proto");
        &update_user_db_entry($login,"TolerationDate=01.01.1970");
    }

    &run_command("sophomorix-check",$verbose);
    &run_command("sophomorix-move",$verbose);


    foreach $user (@userlist){
        my ($txt,$proto)=split(/==/, $user);
        my $login=&get_login_name("$proto");
        &update_user_db_entry($login,"DeactivationDate=01.01.1971");
    }

    &run_command("sophomorix-check",$verbose);
    &run_command("sophomorix-kill",$verbose);

    system("rm /root/sophomorix-test/bunchofusers");
} elsif($remove==1 and not -e "/root/sophomorix-test/bunchofusers") {
    print "The users are removed already!\n";

} else {
    print "Not removing users!\n";
}
