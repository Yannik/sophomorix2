#!/usr/bin/perl -w
# Dieses Script (sophomorix-test) wurde von Rüdiger Beck erstellt
# Es ist freie Software
# Bei Fehlern wenden Sie sich bitte an mich.
# jeffbeck@web.de  oder  jeffbeck@gmx.de


# weiter:

#Auswertung .add, .move, .kill


# Bibliotheken

use strict;
use Getopt::Long;
use Sophomorix::SophomorixBase;
use Sophomorix::SophomorixFiles;
use Sophomorix::SophomorixTest;
use Test::More "no_plan";
Getopt::Long::Configure ("bundling");

# Einlesen der Konfigurationsdatei für Entwickler
{ package DevelConf ; do "/etc/sophomorix/devel/user/sophomorix-devel.conf"}


system("install -d /root/sophomorix-test");

############################################################
# Start
############################################################

my $today=`date +%d.%m.%Y`;
print "\nToday is $today\n";
chomp($today);
my $verbose=0;

&run_command("sophomorix-check",$verbose);

if (3==5){
if (-z "${DevelConf::ergebnis_pfad}/sophomorix.add") {
    print "sophomorix.add ist leer oder nonexistent: OK\n";
} else {
    print "sophomorix.add enthält Daten: ABBRUCH\n\n";
    exit;
}


if (-z "${DevelConf::ergebnis_pfad}/sophomorix.move") {
    print "sophomorix.move ist leer oder nonexistent: OK\n";
} else {
    print "sophomorix.move enthält Daten: ABBRUCH\n\n";
    exit;
}
if (-z "${DevelConf::ergebnis_pfad}/sophomorix.kill") {
    print "sophomorix.kill ist leer oder nonexistent: OK\n";
} else {
    print "sophomorix.kill enthält Daten: ABBRUCH\n\n";
    exit;
}

}
print "\nDie Tests können beginnen\n\n";



###########################################################################
#                                                                         #
#                           ANLEGEN VON SCHÜLERN                          #
#                                                                         #
###########################################################################

###########################################################################
# user in schueler.txt hinzufügen
my $user="";
my $login="";
my @users_to_add=(
     "",
     "m4kb;Maier;Jörg;12.10.1982;",
     "7A;Öztürk;Mohammed;2.4.82;",
     "m1kb;M\203hn;\223liver;12.10.1982;",
   );


foreach $user (@users_to_add){
   &append_line("$user","${DevelConf::users_pfad}/schueler.txt");
}


###########################################################################
# Check
&run_command("sophomorix-check",$verbose);




###########################################################################
# Ergebnisdateien pruefen
# Test
&check_line_in_file(
  "m4kb::maier;joerg;12.10.1982::[a-z]{2,}::[a-z]{3,}",
  "${DevelConf::var_lib_pfad}/ergebnis/sophomorix.add");
# Test
&check_line_in_file(
  "7a::oeztuerk;mohammed;02.04.1982::[a-z]{2,}::[a-z]{3,}",
  "${DevelConf::var_lib_pfad}/ergebnis/sophomorix.add");
# Test
&check_line_in_file(
  "m1kb::mahn;oliver;12.10.1982::[a-z]{2,}::[a-z]{3,}",
  "${DevelConf::var_lib_pfad}/ergebnis/sophomorix.add");
# Test
&check_emptyness("sophomorix.move");
# Test
&check_emptyness("sophomorix.kill");



###########################################################################
# user anlegen
&run_command("sophomorix-add",$verbose);



###########################################################################
# Ergebnisdateien prüfen
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.move");
&check_emptyness("sophomorix.kill");



###########################################################################
# Druckdaten prüfen
# hinzu.tex
&check_existence("${DevelConf::var_lib_pfad}/drucken/hinzu.tex");
&check_line_in_file("joerg maier",
                    "${DevelConf::var_lib_pfad}/drucken/hinzu.tex"),
&check_line_in_file("mohammed oeztuerk",
                    "${DevelConf::var_lib_pfad}/drucken/hinzu.tex"),
&check_line_in_file("oliver mahn",
                    "${DevelConf::var_lib_pfad}/drucken/hinzu.tex"),
# andere
&check_existence("${DevelConf::var_lib_pfad}/drucken/hinzu.dvi");
&check_existence("${DevelConf::var_lib_pfad}/drucken/hinzu.ps");
&check_existence("${DevelConf::var_lib_pfad}/drucken/hinzu.pdf");



###########################################################################
# Datenbank prüfen
&check_line_in_file(":joerg maier:","/etc/passwd"),
&check_line_in_file(
  "m4kb;joerg maier;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982",
  "$DevelConf::protokoll_pfad/user.protokoll");

&check_line_in_file(":mohammed oeztuerk:","/etc/passwd"),
&check_line_in_file(
  "7a;mohammed oeztuerk;[a-z0-9]{2,};[a-z0-9]{3,};02.04.1982",
  "$DevelConf::protokoll_pfad/user.protokoll");

&check_line_in_file(":oliver mahn:","/etc/passwd"),
&check_line_in_file(
  "m1kb;oliver mahn;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982",
  "$DevelConf::protokoll_pfad/user.protokoll");




###########################################################################
#                                                                         #
#                SCHÜLER DULDEN, DEAKTIVIEREN, LOESCHEN                   #
#                                                                         #
###########################################################################


&remove_line(
  "m4kb;Maier;Jörg;12.10.1982;",
  "${DevelConf::users_pfad}/schueler.txt");

&run_command("sophomorix-check",$verbose);

# Test
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.move");
&check_emptyness("sophomorix.kill");

# Is toleration set
&check_line_in_file(":joerg maier:","/etc/passwd"),
&check_line_in_file(
  "m4kb;joerg maier;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982;[A-Za-z0-9]*;[A-D]?;[1-3]?;$today;[\.0-9]*;",
  "$DevelConf::protokoll_pfad/user.protokoll");


$login=&get_login_name("m4kb;joerg maier;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982");

# make user tolerated for a looooong time
&update_user_db_entry($login,"TolerationDate=01.01.1970");
# check if this was succesful
&check_line_in_file(
  "m4kb;joerg maier;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982;[A-Za-z0-9]*;[A-D]?;[1-3]?;01.01.1970;[\.0-9]*;",
  "$DevelConf::protokoll_pfad/user.protokoll");

&run_command("sophomorix-check",$verbose);

# Test if user is moveable to dachboden
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.kill");
&check_line_in_file(
  "maierjo::m4kb::dachboden",
  "${DevelConf::var_lib_pfad}/ergebnis/sophomorix.move");


&run_command("sophomorix-move",$verbose);

# check if user has deactivated settings in user.protokoll
&check_line_in_file(
  "dachboden;joerg maier;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982;[A-Za-z0-9]*;[A-D]?;[1-3]?;01.01.1970;$today;",
  "$DevelConf::protokoll_pfad/user.protokoll");


$login=&get_login_name("dachboden;joerg maier;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982");
&check_account($login,"disabled");

&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.kill");
&check_emptyness("sophomorix.move");


# make user deactivated for a looooong time
&update_user_db_entry($login,"DeactivationDate=01.01.1971");
# check if this was succesful
&check_line_in_file(
  "dachboden;joerg maier;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982;[A-Za-z0-9]*;[A-D]?;[1-3]?;01.01.1970;01.01.1971;",
  "$DevelConf::protokoll_pfad/user.protokoll");

$login=&get_login_name("dachboden;joerg maier;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982");

&run_command("sophomorix-check",$verbose);

&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.move");

&check_line_in_file(
  "maier;joerg;12.10.1982::maierjo",
  "${DevelConf::var_lib_pfad}/ergebnis/sophomorix.kill");


&run_command("sophomorix-kill",$verbose);


# Test: Wird Datenbank upgedated?







exit;



###########################################################################
# User mit Gewalt entfernen
$login=&remove_line(
  "m4kb;joerg maier;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982",
  "$DevelConf::protokoll_pfad/user.protokoll");
&remove_line(
  "m4kb;Maier;Jörg;12.10.1982;",
  "${DevelConf::users_pfad}/schueler.txt");
&kill_user("$login");

$login=&remove_line(
  "7a;mohammed oeztuerk;[a-z0-9]{2,};[a-z0-9]{3,};02.04.1982",
  "$DevelConf::protokoll_pfad/user.protokoll");
&remove_line(
  "7A;Öztürk;Mohammed;2.4.82;",
  "${DevelConf::users_pfad}/schueler.txt");
&kill_user("$login");

$login=&remove_line(
  "m1kb;oliver mahn;[a-z0-9]{2,};[a-z0-9]{3,};12.10.1982",
  "$DevelConf::protokoll_pfad/user.protokoll");
&remove_line(
  "m1kb;M\203hn;\223liver;12.10.1982;",
  "${DevelConf::users_pfad}/schueler.txt");
&kill_user("$login");




















&exchange_line_in_file("fdgdtzz",
   "/etc/sophomorix/user/schueler.txt",
   "13a;Maier;Jörg;12.10.1982;");














