#!/usr/bin/perl -w
# Dieses Script (sophomorix-test) wurde von Rüdiger Beck erstellt
# Es ist freie Software
# Bei Fehlern wenden Sie sich bitte an mich.
# jeffbeck@web.de  oder  jeffbeck@gmx.de


# weiter:

#Auswertung .add, .move, .kill


# Bibliotheken

use strict;
use Getopt::Long;
use Sophomorix::SophomorixConfig;
use Sophomorix::SophomorixBase;
#use Sophomorix::SophomorixFiles;
use Sophomorix::SophomorixPgLdap;
use Sophomorix::SophomorixTest;
use Test::More "no_plan";
Getopt::Long::Configure ("bundling");

use DBI;

# Einlesen der Konfigurationsdatei für Entwickler
#{ package DevelConf ; do "/etc/sophomorix/devel/user/sophomorix-devel.conf"}


system("install -d /root/sophomorix-test");

############################################################
# Start
############################################################

my $today=`date +%d.%m.%Y`;
my $today_pg=`date +%Y-%m-%d`;
chomp($today);
chomp($today_pg);

print "\nToday is $today (pg: $today_pg)\n";
my $verbose=0;

my %account=();


&run_command("sophomorix-check",$verbose);

print "\nDie Tests können beginnen\n\n";


print '
###########################################################################
#                                                                         #
#                                ADDING USERS                             #
#                                                                         #
###########################################################################
';

###########################################################################
# user in schueler.txt hinzufügen
my $user="";
my $login="";
my @users_to_add=(
     "",
     "m4kb;Maier;Jörg;12.10.1982;",
     "7A;Öztürk;Mohammed;2.4.82;",
     "2C;Wall;Larry;2.4.72;",
     "m1kb;M\203hn;\223liver;12.10.1982;987654321;",
   );


foreach $user (@users_to_add){
   &append_line("$user","${DevelConf::users_pfad}/schueler.txt");
}


###########################################################################
# Check
print "Adding $#users_to_add users to schueler.txt\n";
&run_command("sophomorix-check",$verbose);




###########################################################################
# Ergebnisdateien pruefen
# Test
&check_line_in_file(
  "m4kb::maier;joerg;12.10.1982::[-a-z]{2,}::[-a-z]{3,}",
  "${DevelConf::ergebnis_pfad}/sophomorix.add");
# Test
&check_line_in_file(
  "7a::oeztuerk;mohammed;02.04.1982::[-a-z]{2,}::[-a-z]{3,}",
  "${DevelConf::ergebnis_pfad}/sophomorix.add");
# Test
&check_line_in_file(
  "2c::wall;larry;02.04.1972::[-a-z]{2,}::[-a-z]{3,}",
  "${DevelConf::ergebnis_pfad}/sophomorix.add");
# Test
&check_line_in_file(
  "m1kb::mahn;oliver;12.10.1982::[-a-z]{2,}::[-a-z]{3,}",
  "${DevelConf::ergebnis_pfad}/sophomorix.add");

# Test
&check_emptyness("sophomorix.move");
# Test
&check_emptyness("sophomorix.kill");


###########################################################################
# user anlegen
&run_command("sophomorix-add",$verbose);

# doppelt, wegen bug
&run_command("sophomorix-add",$verbose);


###########################################################################
# Ergebnisdateien prüfen
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.move");
&check_emptyness("sophomorix.kill");



###########################################################################
# Druckdaten prüfen
# add.tex
&check_existence("${DevelConf::druck_pfad}/add.tex");
&check_line_in_file("joerg maier",
                    "${DevelConf::druck_pfad}/add.tex");
&check_line_in_file("mohammed oeztuerk",
                    "${DevelConf::druck_pfad}/add.tex");
&check_line_in_file("larry wall",
                    "${DevelConf::druck_pfad}/add.tex");
&check_line_in_file("oliver mahn",
                    "${DevelConf::druck_pfad}/add.tex");
# andere
&check_existence("${DevelConf::druck_pfad}/add.dvi");
&check_existence("${DevelConf::druck_pfad}/add.ps");
&check_existence("${DevelConf::druck_pfad}/add.pdf");



###########################################################################
# Datenbank prüfen

%account = &fetch_single_account("surname='maier' 
                                  AND firstname='joerg'
                                  AND birthday='1982-10-12'
                                  AND adminclass='m4kb'",
                      );
&ok_account("sophomorixstatus", "U");
&ok_account("creationdate", $today_pg);
&ok_account("gecos", "joerg maier");



%account = &fetch_single_account("surname='oeztuerk' 
                                  AND firstname='mohammed'
                                  AND birthday='1982-04-02'
                                  AND adminclass='7a'",
                      );
&ok_account("sophomorixstatus", "U");
&ok_account("creationdate", $today_pg);
&ok_account("gecos", "mohammed oeztuerk");



%account = &fetch_single_account("surname='wall' 
                                  AND firstname='larry'
                                  AND birthday='1972-04-02'
                                  AND adminclass='2c'",
                      );
&ok_account("sophomorixstatus", "U");
&ok_account("creationdate", $today_pg);
&ok_account("gecos", "larry wall");



%account = &fetch_single_account("surname='mahn' 
                                  AND firstname='oliver'
                                  AND birthday='1982-10-12'
                                  AND adminclass='m1kb'",
                      );
&ok_account("sophomorixstatus", "U");
&ok_account("creationdate", $today_pg);
&ok_account("gecos", "oliver mahn");
&ok_account("unid", "987654321");



print '
###########################################################################
#                                                                         #
#                TOLERATE, DEACTIVATE AND DELETE USERS                    #
#                                                                         #
###########################################################################
';


&remove_line(
  "m4kb;Maier;Jörg;12.10.1982;",
  "${DevelConf::users_pfad}/schueler.txt");

&run_command("sophomorix-check",$verbose);

# Test, nothing to do
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.move");
&check_emptyness("sophomorix.kill");

# Is toleration set
%account = &fetch_single_account("surname='maier' 
                                  AND firstname='joerg'
                                  AND birthday='1982-10-12'
                                  AND adminclass='m4kb'",
                      );
&ok_account("sophomorixstatus", "T");
&ok_account("tolerationdate", $today_pg);
&ok_account("gecos", "joerg maier");


# Test if user is moveable to dachboden
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.kill");

&check_line_in_file(
  "${login}::m4kb::dachboden",
  "${DevelConf::ergebnis_pfad}/sophomorix.move");

# move user
&run_command("sophomorix-move",$verbose);

# check movement
%account = &fetch_single_account("surname='maier' 
                                AND firstname='joerg'
                                AND birthday='1982-10-12'
                                AND adminclass='dachboden'",
                              );
&ok_account("exitadminclass", "m4kb");
&ok_account("gecos", "joerg maier");




# Fetch login of user
$login = &fetch_login("surname='maier' 
                       AND firstname='joerg'
                       AND birthday='1982-10-12'
                       AND adminclass='dachboden'",
                     );


# make user tolerated for a looooong time
&update_user_db_entry($login,"TolerationDate=01.01.1970");
%account = &fetch_single_account("surname='maier' 
                                  AND firstname='joerg'
                                  AND birthday='1982-10-12'
                                  AND adminclass='dachboden'",
                      );
&ok_account("sophomorixstatus", "T");
&ok_account("tolerationdate", "1970-01-01");
&ok_account("gecos", "joerg maier");

&run_command("sophomorix-check",$verbose);



# Is deactivation set
%account = &fetch_single_account("surname='maier' 
                                  AND firstname='joerg'
                                  AND birthday='1982-10-12'
                                  AND adminclass='dachboden'",
                      );
&ok_account("sophomorixstatus", "D");
&ok_account("deactivationdate", $today_pg);
&ok_account("tolerationdate", "1970-01-01");
&ok_account("exitadminclass", "m4kb");
&ok_account("gecos", "joerg maier");


# todo ???????????????ßßß
#&check_account($login,"disabled");


# make user deactivated for a looooong time
&update_user_db_entry($login,"DeactivationDate=01.01.1971");

# check if this was succesful
%account = &fetch_single_account("surname='maier' 
                                  AND firstname='joerg'
                                  AND birthday='1982-10-12'
                                  AND adminclass='dachboden'",
                      );
&ok_account("sophomorixstatus", "D");
&ok_account("tolerationdate", "1970-01-01");
&ok_account("deactivationdate", "1971-01-01");
&ok_account("exitadminclass", "m4kb");
&ok_account("gecos", "joerg maier");


&run_command("sophomorix-check",$verbose);


&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.move");

&check_line_in_file(
  "maier;joerg;12.10.1982::${login}",
  "${DevelConf::ergebnis_pfad}/sophomorix.kill");



# todo ?????????????ß
#&run_command("sophomorix-kill",$verbose);

&check_account($login,"nonexisting");




print '
###########################################################################
#                                                                         #
#                STUDENT IS TOLERATED - COMES BACK AGAIN                  #
#                           =========                                     #
###########################################################################
';

&remove_line(
  "7A;Öztürk;Mohammed;2.4.82;",
  "${DevelConf::users_pfad}/schueler.txt");

&run_command("sophomorix-check",$verbose);



# Test
$login = &fetch_login("surname='oeztuerk' 
                       AND firstname='mohammed'
                       AND birthday='1982-04-02'
                       AND adminclass='7a'",
                     );
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.kill");
# Fetch login of user
&check_line_in_file(
  "${login}::7a::dachboden",
  "${DevelConf::ergebnis_pfad}/sophomorix.move");



# Is user tolerated?
%account = &fetch_single_account("surname='oeztuerk' 
                                  AND firstname='mohammed'
                                  AND birthday='1982-04-02'
                                  AND adminclass='7a'",
                      );
&ok_account("sophomorixstatus", "T");
&ok_account("tolerationdate", $today_pg);
&ok_account("gecos", "mohammed oeztuerk");




# The users shows up again in schueler.txt in a different class
&append_line("7C;Öztürk;Mohammed;2.4.82;","${DevelConf::users_pfad}/schueler.txt");

&run_command("sophomorix-check",$verbose);

# Test
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.kill");
&check_line_in_file(
  "${login}::7a::7c",
  "${DevelConf::ergebnis_pfad}/sophomorix.move");



# Reactivation OK?
%account = &fetch_single_account("surname='oeztuerk' 
                                  AND firstname='mohammed'
                                  AND birthday='1982-04-02'
                                  AND adminclass='7a'",
                      );
&ok_account("sophomorixstatus", "E");
&ok_account("tolerationdate", "");
&ok_account("gecos", "mohammed oeztuerk");


&run_command("sophomorix-move",$verbose);


# Move OK?
%account = &fetch_single_account("surname='oeztuerk' 
                                  AND firstname='mohammed'
                                  AND birthday='1982-04-02'
                                  AND adminclass='7c'",
                      );
&ok_account("sophomorixstatus", "E");
&ok_account("tolerationdate", "");
&ok_account("gecos", "mohammed oeztuerk");





# todo ???????????
#&check_account($login,"enabled");



print '
###########################################################################
#                                                                         #
#                  STUDENT IS DEACTIVATED - COMES BACK                    #
#                             ===========                                 #
###########################################################################
';

&remove_line(
  "2C;Wall;Larry;2.4.72;",
  "${DevelConf::users_pfad}/schueler.txt");

&run_command("sophomorix-check",$verbose);
#&run_command("sophomorix-check",$verbose);



# Is user tolerated now? 
%account = &fetch_single_account("surname='wall' 
                                  AND firstname='larry'
                                  AND birthday='1972-04-02'
                                  AND adminclass='2c'",
                      );
&ok_account("sophomorixstatus", "T");
&ok_account("creationdate", $today_pg);
&ok_account("tolerationdate", $today_pg);
&ok_account("gecos", "larry wall");



# Test
$login = &fetch_login("surname='wall' 
                       AND firstname='larry'
                       AND birthday='1972-04-02'
                       AND adminclass='2c'",
                     );
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.kill");
&check_line_in_file(
  "${login}::2c::dachboden",
  "${DevelConf::ergebnis_pfad}/sophomorix.move");



&run_command("sophomorix-move",$verbose);


# make user tolerated for a looooong time
&update_user_db_entry($login,"TolerationDate=01.01.1970");

&run_command("sophomorix-check",$verbose);


# Is user deactivated now? 
%account = &fetch_single_account("surname='wall' 
                                  AND firstname='larry'
                                  AND birthday='1972-04-02'
                                  AND adminclass='dachboden'",
                      );
&ok_account("sophomorixstatus", "D");
&ok_account("creationdate", $today_pg);
&ok_account("tolerationdate", "1970-01-01");
&ok_account("deactivationdate", $today_pg);
&ok_account("gecos", "larry wall");
&ok_account("exitadminclass", "2c");





# todo ????????
#&check_account($login,"disabled");


# The users shows up again in schueler.txt in a different class
&append_line("3C;Wall;Larry;2.4.72;","${DevelConf::users_pfad}/schueler.txt");

&run_command("sophomorix-check",$verbose);

# Test
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.kill");

&check_line_in_file(
  "${login}::dachboden::3c",
  "${DevelConf::ergebnis_pfad}/sophomorix.move");

&run_command("sophomorix-move",$verbose);


# Is user Moved and Enabled
%account = &fetch_single_account("surname='wall' 
                                  AND firstname='larry'
                                  AND birthday='1972-04-02'
                                  AND adminclass='3c'",
                      );
&ok_account("sophomorixstatus", "E");
&ok_account("creationdate", $today_pg);
&ok_account("exitadminclass", "2c");
&ok_account("creationdate", $today_pg);
&ok_account("gecos", "larry wall");


# todo ????????ß
#&check_account($login,"enabled");


print '
###########################################################################
#                                                                         #
#                    TESTING  AUTO-TEACH-IN OF STUDENTS                   #
#                                                                         #
###########################################################################
';

# updating the name Öz -> Ötz
&exchange_line_in_file("7C;Öztürk;Mohammed;2.4.82;*",
   "/etc/sophomorix/user/schueler.txt",
   "7C;Ötztürk;Mohammed;2.4.82;");

&run_command("sophomorix-check",$verbose);

# Test
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.move");
&check_emptyness("sophomorix.kill");

%account = &fetch_single_account("surname='oetztuerk' 
                                  AND firstname='mohammed'
                                  AND birthday='1982-04-02'
                                  AND adminclass='7c'",
                      );
&ok_account("sophomorixstatus", "E");
&ok_account("gecos", "mohammed oetztuerk");


# updating the first Mohhammed -> Mohammad
&exchange_line_in_file("7C;Ötztürk;Mohammed;2.4.82;*",
   "/etc/sophomorix/user/schueler.txt",
   "7C;Ötztürk;Mohammad;2.4.82;");

&run_command("sophomorix-check",$verbose);

# Test
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.move");
&check_emptyness("sophomorix.kill");



%account = &fetch_single_account("surname='oetztuerk' 
                                  AND firstname='mohammad'
                                  AND birthday='1982-04-02'
                                  AND adminclass='7c'",
                      );
&ok_account("sophomorixstatus", "E");
&ok_account("gecos", "mohammad oetztuerk");


# updating birth 82 -> 83
&exchange_line_in_file("7C;Ötztürk;Mohammad;2.4.82;*",
   "/etc/sophomorix/user/schueler.txt",
   "7C;Ötztürk;Mohammad;2.4.83;");

&run_command("sophomorix-check",$verbose);

# Test
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.move");
&check_emptyness("sophomorix.kill");

%account = &fetch_single_account("surname='oetztuerk' 
                                  AND firstname='mohammad'
                                  AND birthday='1983-04-02'
                                  AND adminclass='7c'",
                      );
&ok_account("sophomorixstatus", "E");
&ok_account("gecos", "mohammad oetztuerk");




print '
###########################################################################
#                                                                         #
#              TESTING UPLOADING UNID, CHANGE DATA USING UNID             #
#                                                                         #
###########################################################################
';

# updating the unid automatically
&exchange_line_in_file("3C;Wall;Larry;2.4.72;*",
   "/etc/sophomorix/user/schueler.txt",
   "3C;Wall;Larry;2.4.72;123456789;");

&run_command("sophomorix-check",$verbose);

# Test
&check_emptyness("sophomorix.add");
&check_emptyness("sophomorix.move");
&check_emptyness("sophomorix.kill");

%account = &fetch_single_account("surname='wall' 
                                  AND firstname='larry'
                                  AND birthday='1972-04-02'
                                  AND adminclass='3c'",
                      );
&ok_account("sophomorixstatus", "E");
&ok_account("creationdate", $today_pg);
&ok_account("gecos", "larry wall");
&ok_account("unid", "123456789");


# new name, first, birth
&exchange_line_in_file("3C;Wall;Larry;2.4.72;*",
   "/etc/sophomorix/user/schueler.txt",
   "3C;Stallman;Richard;2.4.62;123456789;");


&run_command("sophomorix-check",$verbose);



%account = &fetch_single_account("surname='stallman' 
                                  AND firstname='richard'
                                  AND birthday='1962-04-02'
                                  AND adminclass='3c'",
                      );
&ok_account("sophomorixstatus", "E");
&ok_account("creationdate", $today_pg);
&ok_account("gecos", "richard stallman");
&ok_account("unid", "123456789");




print '
###########################################################################
#                                                                         #
#                               DELETE UNIT                               #
#                                                                         #
###########################################################################
';



# removing the unid from userfile
&exchange_line_in_file("m1kb;M\203hn;\223liver;12.10.1982;987654321;",
   "/etc/sophomorix/user/schueler.txt",
   "m1kb;M\203hn;\223liver;12.10.1982;");



&run_command("sophomorix-check",$verbose);

# check if unid is now removed
%account = &fetch_single_account("surname='mahn' 
                                  AND firstname='oliver'
                                  AND birthday='1982-10-12'
                                  AND adminclass='m1kb'",
                      );
&ok_account("sophomorixstatus", "U");
&ok_account("creationdate", $today_pg);
&ok_account("gecos", "oliver mahn");
&ok_account("unid", "");







print '
###########################################################################
#                                                                         #
#                              REMOVING USERS                             #
#                                                                         #
###########################################################################
';


&remove_line(
  "7C;Ötztürk;Mohammad;2.4.83;",
  "${DevelConf::users_pfad}/schueler.txt");
&remove_line(
  "3C;Stallman;Richard;2.4.62;",
  "${DevelConf::users_pfad}/schueler.txt");
&remove_line(
  "m1kb;M\203hn;\223liver;12.10.1982;",
  "${DevelConf::users_pfad}/schueler.txt");


&run_command("sophomorix-check",$verbose);


# colecting all logins
my @logins=();

$login = &fetch_login("surname='oetztuerk' 
                       AND firstname='mohammad'
                       AND birthday='1983-04-02'
                       AND adminclass='7c'",
                     );
push @logins, $login;

$login = &fetch_login("surname='stallman' 
                       AND firstname='richard'
                       AND birthday='1962-04-02'
                       AND adminclass='3c'",
                     );
push @logins, $login;

$login = &fetch_login("surname='mahn' 
                       AND firstname='oliver'
                       AND birthday='1982-10-12'
                       AND adminclass='m1kb'",
                     );
push @logins, $login;




# make user tolerated for a looooong time
foreach my $login (@logins){
    &update_user_db_entry($login,"TolerationDate=01.01.1970");
}



&run_command("sophomorix-check",$verbose);
&run_command("sophomorix-move",$verbose);


foreach my $login (@logins){
   # todo ???????
   #&check_account($login,"disabled");
}


# make user deactivated for a looooong time
foreach my $login (@logins){
   &update_user_db_entry($login,"DeactivationDate=01.01.1971");
}



&run_command("sophomorix-check",$verbose);


# todo ?????????ß
#&run_command("sophomorix-kill",$verbose);


foreach my $login (@logins){
   #&check_account($login,"nonexisting");
}








###########################################################################
# SUB
###########################################################################

sub ok_account{
    # Hash must be in %account, wich is global in this file
    my ($col, $v) = @_;
    # Make sure that its defined
    if (not defined $account{$col} ){
	$account{$col}="";
    };
    is( $account{$col},$v, "checking if $v is $col of user $account{uid}");
}








